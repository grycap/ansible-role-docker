- name: Include "{{ansible_os_family}}" tasks
  include: "{{ansible_os_family}}.yml"

- name: Create directory for registry keys
  file:
    path: "/etc/docker/certs.d/{{private_dns_name}}:5000/"
    state: directory

- name: Create directory for the docker certs
  file:
    path: "/opt/docker_registry/certs"
    state: directory

- name: Include "{{docker_type_of_node}}" docker recipe
  include: "{{docker_type_of_node}}.yml"

- name: Copy {{registry_name}}.cert file
  copy:
    src: "/tmp/{{registry_name}}.cert"
    dest: "/etc/docker/certs.d/{{registry_name}}:5000/{{registry_name}}.cert"

- name: Copy {{registry_name}}.key file
  copy:
    src: "/tmp/{{registry_name}}.key"
    dest: "/etc/docker/certs.d/{{registry_name}}:5000/{{registry_name}}.key"

- name: Copy ca.crt file
  copy:
    src: /tmp/ca.crt
    dest: "/etc/docker/certs.d/{{registry_name}}:5000/ca.crt"

- name: Set DOCKER_OPTS
  lineinfile:
    dest: /etc/default/docker
    regexp: 'DOCKER_OPTS='
    line: 'DOCKER_OPTS="{{docker_opts}}"'
  when: docker_opts != ""
  notify:
  - restart docker

# Enable to read the docker default values
- lineinfile:
    dest: /lib/systemd/system/docker.service
    insertbefore: '^ExecStart='
    line: 'EnvironmentFile=/etc/default/docker'
  notify:
  - reload systemctl
  - restart docker
  when: ansible_os_family == "Debian"

- lineinfile:
    dest: /lib/systemd/system/docker.service
    regexp: '^(ExecStart=)(.*)(-H fd://)$'
    line: '\1\2\3 $DOCKER_OPTS'
    backrefs: yes
  notify:
  - reload systemctl
  - restart docker
  when: (ansible_os_family == "RedHat" and ansible_distribution_major_version == "7") or
        (ansible_os_family == "Debian" )
