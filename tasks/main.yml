- name: Check docker if docker service is running
  service: name=docker state=started
  register: docker_service_running
  ignore_errors: yes

-block:
  - name: Include "{{ansible_os_family}}" tasks
    include: "{{ansible_os_family}}.yml"

  - stat: path=/lib/systemd/system/docker.service
    register: docker_service


  - block:
    - name: Set DOCKER_OPTS
      lineinfile:
        dest: /etc/default/docker
        regexp: 'DOCKER_OPTS='
        line: 'DOCKER_OPTS="{{docker_opts}}"'
      when: docker_opts != ""

    # Enable to read the docker default values
    - lineinfile:
        dest: /lib/systemd/system/docker.service
        insertbefore: '^ExecStart='
        line: 'EnvironmentFile=/etc/default/docker'

    - lineinfile:
        dest: /lib/systemd/system/docker.service
        regexp: '^(ExecStart=)(.*)(-H fd://)$'
        line: '\1\2\3 $DOCKER_OPTS'
        backrefs: yes
      notify:
      - reload systemctl
      - restart docker
    when: docker_service.stat.exists

when: docker_service_running|failed
