- stat: path=/usr/bin/docker
  register: docker_bin

- block:
  - name: Include "{{ansible_os_family}}" tasks
    include: "{{ansible_os_family}}.yml"

  - name: Set DOCKER_OPTS
    lineinfile:
      dest: /etc/default/docker
      regexp: 'DOCKER_OPTS='
      line: 'DOCKER_OPTS="{{docker_opts}}"'
    when: docker_opts != ""
    notify:
    - restart docker

  # Enable to read the docker default values
  - lineinfile:
      dest: /lib/systemd/system/docker.service
      insertbefore: '^ExecStart='
      line: 'EnvironmentFile=/etc/default/docker'
    notify:
    - reload systemctl
    - restart docker
    when: ansible_distribution == "Debian"

  - lineinfile:
      dest: /lib/systemd/system/docker.service
      regexp: '^(ExecStart=)(.*)(-H fd://)$'
      line: '\1\2\3 $DOCKER_OPTS'
      backrefs: yes
    notify:
    - reload systemctl
    - restart docker
    when: (ansible_distribution == "RedHat" and ansible_distribution_major_version == "7") or
          (ansible_distribution == "Debian" )

  when: not docker_bin.stat.exists
