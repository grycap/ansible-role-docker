- name: Include "{{ansible_os_family}}" tasks
  include: "{{ansible_os_family}}.yml"

- stat: path=/lib/systemd/system/docker.service
  register: docker_service

- name: Set DOCKER_OPTS
  lineinfile:
    dest: /etc/default/docker
    regexp: 'DOCKER_OPTS='
    line: 'DOCKER_OPTS="{{docker_opts}}"'
  notify: restart docker
  when: docker_opts != ""

  # Enable to read the docker default values
- block:
  - lineinfile:
      dest: /lib/systemd/system/docker.service
      insertbefore: '^ExecStart='
      line: 'EnvironmentFile=/etc/default/docker'
    notify:
    - reload systemctl
    - restart docker

  - lineinfile:
      dest: /lib/systemd/system/docker.service
      regexp: '^(ExecStart=)(.*)(-H fd://)$'
      line: '\1\2\3 $DOCKER_OPTS'
      backrefs: yes
    notify:
    - reload systemctl
    - restart docker
  when: docker_service.stat.exists

- service: name=docker state=started
  when: docker_start_service
